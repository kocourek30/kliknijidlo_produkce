{% extends "admin/base_site.html" %}

{% block content %}
<div style="max-width: 1200px;">
    <h1>ğŸ‘ï¸ NÃ¡hled pÅ™epoÄtu cen</h1>
    
    <div class="module" style="margin: 20px 0; padding: 15px; background: #e8f4f8; border-left: 4px solid #3498db;">
        <h3>ğŸ“Š Souhrn</h3>
        <table style="width: 100%;">
            <tr>
                <td><strong>ObdobÃ­:</strong></td>
                <td>{{ date_from|date:'d.m.Y' }} - {{ date_to|date:'d.m.Y' }}</td>
            </tr>
            <tr>
                <td><strong>Celkem poloÅ¾ek:</strong></td>
                <td>{{ result.items_total }}</td>
            </tr>
            <tr>
                <td><strong>ZmÄ›nÄ›nÃ½ch poloÅ¾ek:</strong></td>
                <td style="color: #e67e22; font-weight: bold;">{{ result.items_changed }}</td>
            </tr>
            <tr>
                <td><strong>Beze zmÄ›ny:</strong></td>
                <td>{{ result.items_unchanged }}</td>
            </tr>
            <tr>
                <td><strong>OvlivnÄ›nÃ½ch objednÃ¡vek:</strong></td>
                <td>{{ result.orders_affected }}</td>
            </tr>
            <tr>
                <td><strong>CelkovÃ½ cenovÃ½ rozdÃ­l:</strong></td>
                <td>
                    <span style="font-size: 18px; font-weight: bold; color: {% if result.total_price_diff > 0 %}red{% elif result.total_price_diff < 0 %}green{% else %}gray{% endif %};">
                        {% if result.total_price_diff > 0 %}+{% endif %}{{ result.total_price_diff|floatformat:2 }} KÄ
                    </span>
                </td>
            </tr>
        </table>
    </div>
    
    {% if result.items_changed == 0 %}
        <div class="module" style="padding: 15px; background: #d4edda; border-left: 4px solid #28a745;">
            <p style="margin: 0;"><strong>âœ… Å½Ã¡dnÃ© zmÄ›ny</strong> - vÅ¡echny ceny odpovÃ­dajÃ­ aktuÃ¡lnÃ­mu nastavenÃ­.</p>
        </div>
        
        <a href="{% url 'admin:objednavky_order_price_recalculation' %}" class="button">
            â† ZpÄ›t
        </a>
    {% else %}
        <h2>ğŸ‘¥ ZmÄ›ny podle uÅ¾ivatelÅ¯</h2>
        
        {% for user, data in by_user.items %}
        <div class="module" style="margin-bottom: 20px; border: 1px solid #ddd;">
            <h3 style="background: #f5f5f5; padding: 10px; margin: 0;">
                {{ user.get_full_name }} ({{ user.username }})
                - {{ data.items_count }} poloÅ¾ek
                - RozdÃ­l: 
                <span style="color: {% if data.total_diff > 0 %}red{% elif data.total_diff < 0 %}green{% else %}gray{% endif %};">
                    {% if data.total_diff > 0 %}+{% endif %}{{ data.total_diff|floatformat:2 }} KÄ
                </span>
            </h3>
            
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: #f9f9f9;">
                        <th style="padding: 8px; text-align: left; border-bottom: 2px solid #ddd;">Datum</th>
                        <th style="padding: 8px; text-align: left; border-bottom: 2px solid #ddd;">JÃ­dlo</th>
                        <th style="padding: 8px; text-align: right; border-bottom: 2px solid #ddd;">MnoÅ¾stvÃ­</th>
                        <th style="padding: 8px; text-align: right; border-bottom: 2px solid #ddd;">StarÃ¡ cena</th>
                        <th style="padding: 8px; text-align: right; border-bottom: 2px solid #ddd;">NovÃ¡ cena</th>
                        <th style="padding: 8px; text-align: right; border-bottom: 2px solid #ddd;">RozdÃ­l/ks</th>
                        <th style="padding: 8px; text-align: right; border-bottom: 2px solid #ddd;">Celkem</th>
                    </tr>
                </thead>
                <tbody>
                    {% for change in data.items %}
                    <tr>
                        <td style="padding: 8px; border-bottom: 1px solid #eee;">{{ change.date|date:'d.m.Y' }}</td>
                        <td style="padding: 8px; border-bottom: 1px solid #eee;">{{ change.menu_item_name }}</td>
                        <td style="padding: 8px; text-align: right; border-bottom: 1px solid #eee;">{{ change.quantity }}Ã—</td>
                        <td style="padding: 8px; text-align: right; border-bottom: 1px solid #eee;">{{ change.old_price|floatformat:2 }} KÄ</td>
                        <td style="padding: 8px; text-align: right; border-bottom: 1px solid #eee;">{{ change.new_price|floatformat:2 }} KÄ</td>
                        <td style="padding: 8px; text-align: right; border-bottom: 1px solid #eee; color: {% if change.price_diff > 0 %}red{% elif change.price_diff < 0 %}green{% endif %};">
                            {% if change.price_diff > 0 %}+{% endif %}{{ change.price_diff|floatformat:2 }} KÄ
                        </td>
                        <td style="padding: 8px; text-align: right; border-bottom: 1px solid #eee; font-weight: bold; color: {% if change.total_diff > 0 %}red{% elif change.total_diff < 0 %}green{% endif %};">
                            {% if change.total_diff > 0 %}+{% endif %}{{ change.total_diff|floatformat:2 }} KÄ
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endfor %}
        
        <div style="margin-top: 30px; padding: 20px; background: #fff3cd; border: 2px solid #ffc107;">
            <h3 style="margin-top: 0;">âš ï¸ Potvrdit pÅ™epoÄet?</h3>
            <p>TÃ­mto provedete <strong>NEVRATNOU</strong> zmÄ›nu cen a zÅ¯statkÅ¯ uÅ¾ivatelÅ¯.</p>
            
            <form method="post" style="display: inline;">
                {% csrf_token %}
                <input type="hidden" name="date_from" value="{{ date_from|date:'Y-m-d' }}">
                <input type="hidden" name="date_to" value="{{ date_to|date:'Y-m-d' }}">
                
                <button 
                    type="submit" 
                    name="action" 
                    value="confirm"
                    class="button default"
                    style="padding: 10px 20px; font-size: 16px; background: #28a745; color: white;"
                    onclick="return confirm('Opravdu chcete provÃ©st pÅ™epoÄet cen?');"
                >
                    âœ… Potvrdit a provÃ©st pÅ™epoÄet
                </button>
            </form>
            
            <a href="{% url 'admin:objednavky_order_price_recalculation' %}" class="button" style="margin-left: 10px;">
                â† ZpÄ›t na formulÃ¡Å™
            </a>
        </div>
    {% endif %}
</div>
{% endblock %}
