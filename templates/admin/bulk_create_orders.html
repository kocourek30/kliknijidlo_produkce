{% extends "admin/base_site.html" %}
{% load static %}
{% block extrahead %}
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
  .order-form-flex {
    display: flex;
    flex-direction: row;
    gap: 2rem;
    align-items: flex-start;
  }
  #calendar {
    max-width: 500px;
    min-width: 340px;
    margin: 1rem auto;
  }
  .fc-daygrid-day.fc-day-with-menu {
    background-color: #d1e7dd !important;
    cursor: pointer;
  }
  .fc-daygrid-day-selected {
    box-shadow: inset 0 0 0 3px #198754;
    background-color: #bcd9c6 !important;
  }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
  <h1>Hromadné vytvoření objednávek</h1>
  <div class="order-form-flex">
    <div>
      <div id="calendar"></div>
    </div>
    <div style="flex:1;">
      <form method="post" id="bulkOrderForm" class="mt-3">
        {% csrf_token %}
        {% if form.errors %}
          <div class="alert alert-danger">{{ form.errors }}</div>
        {% endif %}
        <input type="hidden" name="datum_vydeje" id="selectedDate" value="">
        <div class="mb-3">
          <label class="form-label">Položky jídelníčku</label>
          <div id="menu-items-container">Vyber datum z kalendáře</div>
        </div>
        <div class="mb-3">
          <label class="form-label" for="id_skupina">Skupina zákazníků</label>
          {{ form.skupina }}
        </div>
        <div class="mb-3">
          <label class="form-label" for="id_uzivatele">Uživatelé</label>
          <input type="text" id="user-search" class="form-control mb-2" placeholder="Vyhledat (jméno, příjmení, osobní číslo, login)">
          <div id="user-select-container">
            {{ form.uzivatele }}
          </div>
        </div>
        <button type="submit" class="btn btn-success" disabled id="submitBtn">Vytvořit objednávky</button>
        <a href="{% url 'admin:objednavky_order_changelist' %}" class="btn btn-secondary ms-2">Zpět na objednávky</a>
      </form>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    let selectedDate = '';
    const submitBtn = document.getElementById('submitBtn');
    let availableDates = [];
    const calendarEl = document.getElementById('calendar');
    const calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'dayGridMonth',
      selectable: false,
      dateClick: function(info) {
        if (availableDates.includes(info.dateStr)) {
          selectedDate = info.dateStr;
          document.getElementById('selectedDate').value = selectedDate;
          loadMenuItems(selectedDate);
          submitBtn.disabled = false;
          calendar.getDateEl().querySelectorAll('.fc-daygrid-day-selected').forEach(el => el.classList.remove('fc-daygrid-day-selected'));
          const clickedEl = info.dayEl;
          clickedEl.classList.add('fc-daygrid-day-selected');
        } else {
          alert("Vyber prosím den, kdy je vytvořen jídelníček.");
        }
      },
      datesSet: function() {
        fetch('/admin/objednavky/order/api/jidelnicek_days/')
          .then(response => response.json())
          .then(days => {
            availableDates = days;
            calendar.getEvents().forEach(ev => ev.remove());
            days.forEach(day => {
              calendar.addEvent({
                title: 'Menu',
                start: day,
                allDay: true,
                display: 'background',
                classNames: ['fc-daygrid-day-with-menu']
              });
            });
          });
      }
    });
    calendar.render();

    function loadMenuItems(datum) {
      fetch(`/admin/objednavky/order/api/menu_items/?datum=${datum}`)
        .then(res => res.json())
        .then(data => {
          let html = '';
          if(data.length === 0) {
            html = '<p>Pro zvolené datum není žádný jídelníček.</p>';
          } else {
            data.forEach(item => {
              html += `<div class="form-check">
                <input class="form-check-input" type="checkbox" name="menu_items" value="${item.id}" id="menu_item_${item.id}">
                <label class="form-check-label" for="menu_item_${item.id}">${item.nazev}</label>
              </div>`;
            });
          }
          document.getElementById('menu-items-container').innerHTML = html;
        });
    }

    // Dynamické načítání a vyhledávání zákazníků podle skupiny
    const skupinaField = document.getElementById('id_skupina');
    const userSearchInput = document.getElementById('user-search');
    function loadUsers(query='') {
      const groupId = skupinaField.value;
      let params = [];
      if (groupId) params.push(`skupina=${groupId}`);
      if (query && query.trim().length > 0) params.push(`q=${encodeURIComponent(query)}`);
      const url = '/admin/objednavky/order/api/zákazníci/?' + params.join('&');
      fetch(url)
        .then(res => res.json())
        .then(users => {
          let html = '<select name="uzivatele" multiple class="form-select" id="id_uzivatele">';
          users.forEach(user => {
            html += `<option value="${user.id}">${user.osobni_cislo ? user.osobni_cislo : ''} - ${user.name} (${user.username})</option>`;
          });
          html += '</select>';
          document.getElementById('user-select-container').innerHTML = html;
        });
    }
    skupinaField.addEventListener('change', () => loadUsers(userSearchInput.value));
    userSearchInput.addEventListener('input', () => loadUsers(userSearchInput.value));
    loadUsers();
  });
</script>
{% endblock %}
