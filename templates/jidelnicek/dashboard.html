{% extends 'base.html' %}
{% load static %}

{% block title %}J√≠deln√≠ƒçek - {{ selected_date|date:"d.m.Y" }}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Toast notifikace -->
    <div id="toast-container" class="position-fixed top-0 start-50 translate-middle-x p-3" style="z-index: 1080; width: 100%; max-width: 420px;"></div>

    <div class="row">
        <!-- Prav√° sekce: kalend√°≈ô + objedn√°vky -->
        <div class="col-md-3 order-md-2">
            <div class="position-sticky" style="top: 1rem;">
                <!-- ‚úÖ STAV KONTA - aktualizovateln√Ω kontejner -->
                <div id="account-status-container" class="alert alert-success shadow-md border-0 mb-3 p-3 modern-account-status compact">
                    {% include 'includes/_account_status.html' with balance=request.user.aktualni_zustatek %}
                </div>
                
                <!-- Kalend√°≈ô -->
                <div class="card mb-3 shadow-lg rounded-3 overflow-hidden modern-card compact">
                    <div class="card-header bg-gradient-primary text-white d-flex justify-content-between align-items-center py-2 px-3">
                        <span class="fs-6 fw-bold d-flex align-items-center">
                            <i class="fas fa-calendar me-2"></i>Kalend√°≈ô
                        </span>
                        <small class="bg-light text-dark px-2 py-1 rounded fw-semibold opacity-90">({{ days_with_menu|length }} dn≈Ø)</small>
                    </div>
                    <div class="card-body p-2">
                        <!-- Navigace mƒõs√≠c≈Ø -->
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <a href="?month={{ prev_month.month }}&year={{ prev_year }}&filter={{ filter }}" class="btn btn-light btn-sm px-2 py-1" aria-label="P≈ôedchoz√≠ mƒõs√≠c">
                                <i class="fa fa-chevron-left"></i>
                            </a>
                            <span class="fw-bold text-dark small">{{ current_month|date:"F Y" }}</span>
                            <a href="?month={{ next_month.month }}&year={{ next_year }}&filter={{ filter }}" class="btn btn-light btn-sm px-2 py-1" aria-label="Dal≈°√≠ mƒõs√≠c">
                                <i class="fa fa-chevron-right"></i>
                            </a>
                        </div>
                        
                        <!-- Kalend√°≈ô tabulka -->
                        <div class="table-responsive">
                            <table class="table table-bordered text-center mb-0 modern-calendar-table compact">
                                <thead>
                                    <tr>
                                        <th class="modern-day-header compact">Po</th>
                                        <th class="modern-day-header compact">√öt</th>
                                        <th class="modern-day-header compact">St</th>
                                        <th class="modern-day-header compact">ƒåt</th>
                                        <th class="modern-day-header compact">P√°</th>
                                        <th class="modern-day-header compact">So</th>
                                        <th class="modern-day-header compact">Ne</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for week in calendar_weeks %}
                                    <tr>
                                        {% for day in week %}
                                        <td class="{% if not day.month == current_month.month %}text-muted bg-light-soft
                                            {% elif day == selected_date %}bg-warning-soft text-dark fw-bold selected-day-soft
                                            {% elif day in days_with_menu %}bg-success-soft menu-day-soft
                                            {% else %}bg-light-soft{% endif %} p-2 day-cell-soft modern-day-cell compact">
                                            {% if day.month == current_month.month %}
                                                {% if day in days_with_menu %}
                                                    <a href="?filter=date&date={{ day|date:'Y-m-d' }}" class="text-decoration-none d-block p-2 rounded-2 menu-day-link-soft fw-semibold">
                                                        {{ day.day }}
                                                    </a>
                                                {% else %}
                                                    <div class="p-2">{{ day.day }}</div>
                                                {% endif %}
                                            {% elif day.month != current_month.month and day in days_with_menu %}
                                                <a href="?filter=date&date={{ day|date:'Y-m-d' }}" class="text-decoration-none d-block p-2 rounded-2 text-muted">
                                                    {{ day.day }}
                                                </a>
                                            {% else %}
                                                <div class="p-2 text-muted opacity-50">{{ day.day }}</div>
                                            {% endif %}
                                        </td>
                                        {% endfor %}
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Moje objedn√°vky -->
                <div class="card shadow-lg rounded-3 overflow-hidden modern-card compact">
                    <div class="card-header bg-gradient-accent text-white py-2 px-3 fs-6 fw-bold">
                        <i class="fas fa-shopping-cart me-2"></i>Aktu√°ln√≠ objedn√°vky
                    </div>
                    <div id="my-orders-wrapper" class="p-3">
                        {% include 'includes/_my_orders.html' %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Lev√° sekce: j√≠deln√≠ƒçek -->
        <div class="col-md-9 order-md-1">
            <!-- Taby s poƒç√≠tadly -->
            <ul class="nav nav-tabs mb-4 custom-menu-tabs-modern shadow-lg rounded-3 overflow-hidden compact" id="menuTabs" role="tablist">
                <li class="nav-item flex-fill" role="presentation">
                    <button class="nav-link w-100 py-3 {% if filter == 'date' %}active{% endif %}"
                            id="tab-day" data-bs-toggle="tab" data-bs-target="#tab-pane-day" type="button" role="tab">
                        <i class="fa fa-calendar-day me-2"></i>Den 
                        <span class="badge bg-light text-dark px-2 py-1 fw-semibold">{{ menu_items|length|default:"0" }}</span>
                    </button>
                </li>
                <li class="nav-item flex-fill" role="presentation">
                    <button class="nav-link w-100 py-3 {% if filter == 'week' %}active{% endif %}"
                            id="tab-week" data-bs-toggle="tab" data-bs-target="#tab-pane-week" type="button" role="tab">
                        <i class="fa fa-calendar-week me-2"></i>T√Ωden 
                        <span class="badge bg-light text-dark px-2 py-1 fw-semibold">{{ week_items_count|default:"0" }}</span>
                    </button>
                </li>
                <li class="nav-item flex-fill" role="presentation">
                    <button class="nav-link w-100 py-3 {% if filter == 'month' %}active{% endif %}"
                            id="tab-month" data-bs-toggle="tab" data-bs-target="#tab-pane-month" type="button" role="tab">
                        <i class="fa fa-calendar-month me-2"></i>Mƒõs√≠c 
                        <span class="badge bg-light text-dark px-2 py-1 fw-semibold">{{ month_items_count|default:"0" }}</span>
                    </button>
                </li>
            </ul>

            <!-- Nadpis -->
            <div class="row mb-4">
                <div class="col">
                    <h4 class="fw-bold mb-2 compact-title">
                        <i class="fa fa-utensils me-2 text-primary"></i>
                        {% if filter == 'week' %}
                            T√Ωden {{ week_start|date:"d.m." }} - {{ week_end|date:"d.m.Y" }}
                        {% elif filter == 'month' %}
                            {{ current_month|date:"F Y" }}
                        {% else %}
                            {{ selected_date|date:"d.m.Y (l)" }}
                        {% endif %}
                    </h4>
                    {% if filter == 'date' and menu_items %}
                        <small class="text-muted">üì¶ {{ menu_items|length }} polo≈æek</small>
                    {% elif filter == 'week' and menu_items_by_day %}
                        <small class="text-muted">üì¶ {{ menu_items_by_day|length }} dn√≠</small>
                    {% elif filter == 'month' and menu_items_by_day %}
                        <small class="text-muted">üì¶ {{ menu_items_by_day|length }} dn√≠</small>
                    {% endif %}
                </div>
            </div>

            <!-- Tab content -->
            <div class="tab-content" id="menuTabsContent">
                <!-- DEN -->
                <div class="tab-pane fade {% if filter == 'date' %}show active{% endif %}" id="tab-pane-day" role="tabpanel">
                    {% if menu_items %}
                        {% for item in menu_items %}
                            <div class="menu-item-wrapper" data-menu-item-id="{{ item.id }}" data-menu-date="{{ selected_date|date:'Y-m-d' }}">
                                {% include 'jidelnicek_item.html' with item=item %}
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="alert alert-info d-flex align-items-center shadow-md rounded-3 p-4 mb-0 modern-alert compact">
                            <i class="fa fa-info-circle me-3 text-info"></i>
                            <strong>Pro tento den nen√≠ ≈æ√°dn√Ω j√≠deln√≠ƒçek.</strong>
                        </div>
                    {% endif %}
                </div>

                <!-- T√ùDEN -->
                <div class="tab-pane fade {% if filter == 'week' %}show active{% endif %}" id="tab-pane-week" role="tabpanel">
                    {% if menu_items_by_day %}
                        {% for day, items in menu_items_by_day.items %}
                            <div class="mb-4 p-4 bg-light-soft rounded-3 shadow-md modern-day-section compact">
                                <h6 class="fw-bold border-bottom border-light pb-3 mb-4">
                                    {{ day|date:"d.m.Y (l)" }}
                                    <span class="badge bg-gradient-primary text-white px-2 py-1 ms-2">{{ items|length }}</span>
                                </h6>
                                {% for item in items %}
                                    <div class="menu-item-wrapper" data-menu-item-id="{{ item.id }}" data-menu-date="{{ day|date:'Y-m-d' }}">
                                        {% include 'jidelnicek_item.html' with item=item date=day %}
                                    </div>
                                {% endfor %}
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="alert alert-info d-flex align-items-center shadow-md rounded-3 p-4 mb-0 modern-alert compact">
                            <i class="fa fa-info-circle me-3 text-info"></i>
                            <strong>Pro tento t√Ωden nen√≠ ≈æ√°dn√Ω j√≠deln√≠ƒçek.</strong>
                        </div>
                    {% endif %}
                </div>

                <!-- MƒöS√çC -->
                <div class="tab-pane fade {% if filter == 'month' %}show active{% endif %}" id="tab-pane-month" role="tabpanel">
                    {% if menu_items_by_day %}
                        {% for day, items in menu_items_by_day.items %}
                            <div class="mb-3 p-3 bg-light-soft rounded-3 shadow-sm modern-day-section compact">
                                <h6 class="fw-bold border-bottom border-light pb-2 mb-3 small">
                                    {{ day|date:"d.m.Y" }}
                                    <span class="badge bg-gradient-primary text-white px-2 py-1 ms-2">{{ items|length }}</span>
                                </h6>
                                {% for item in items %}
                                    <div class="menu-item-wrapper" data-menu-item-id="{{ item.id }}" data-menu-date="{{ day|date:'Y-m-d' }}">
                                        {% include 'jidelnicek_item.html' with item=item date=day %}
                                    </div>
                                {% endfor %}
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="alert alert-info d-flex align-items-center shadow-md rounded-3 p-4 mb-0 modern-alert compact">
                            <i class="fa fa-info-circle me-3 text-info"></i>
                            <strong>Pro tento mƒõs√≠c nen√≠ ≈æ√°dn√Ω j√≠deln√≠ƒçek.</strong>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // ‚úÖ AJAX HANDLER - Hlavn√≠ oprava pro RU≈†EN√ç
    // ‚úÖ AJAX HANDLER - PLNƒö OPRAVEN√ù PRO OBJEDN√ÅVKU I RU≈†EN√ç
    document.addEventListener('submit', function(e) {
        if (!e.target.classList.contains('ajax-order-form')) return;
        
        e.preventDefault();
        
        const form = e.target;
        const submitBtn = form.querySelector('button[type="submit"]');
        const originalText = submitBtn ? submitBtn.innerHTML : '';
        
        if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Zpracov√°v√°m...';
        }
        
        fetch(form.action, {
            method: 'POST',
            body: new FormData(form),
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(r => r.json())
        .then(data => {
            console.log('‚úÖ AJAX RESPONSE:', data);
            
            // 1. MY ORDERS - perfektnƒõ funguje
            if (data.my_orders_html) {
                document.getElementById('my-orders-wrapper').innerHTML = data.my_orders_html;
            }
            
            // 2. DASHBOARD ITEM - ‚úÖ PLNƒö OPRAVEN√â
            // 2. DASHBOARD ITEM - ULTRA JISTE
            if (data.item_html && data.menu_item_id) {
                const menuItemId = data.menu_item_id;
                const wrapper = form.closest('.menu-item-wrapper') || 
                               document.querySelector(`[data-menu-item-id="${menuItemId}"]`);
                
                console.log('üéØ WRAPPER:', wrapper);
                
                if (wrapper) {
                    wrapper.innerHTML = data.item_html;
                    console.log('‚úÖ TLAƒå√çTKO OK!');
                }
            }
            
            // 3. STAV KONTA
            if (data.account_html) {
                document.getElementById('account-status-container').innerHTML = data.account_html;
            }
            
            if (data.message) {
                showToast(data.message, data.status || 'info');
            }
        })
        .catch(err => {
            console.error('üí• AJAX ERROR:', err);
            showToast('Chyba p≈ôi zpracov√°n√≠ po≈æadavku', 'error');
        })
        .finally(() => {
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        });
    });

    // Potvrzovac√≠ dialogy + taby (beze zmƒõny)
    document.addEventListener('click', function(e) {
        if (e.target.closest('.btn-order-cancel')) {
            if (!confirm('Opravdu chcete zru≈°it objedn√°vku?')) {
                e.preventDefault();
                return false;
            }
        }
    });

    // Ulo≈æen√≠ aktivn√≠ho tabu
    const savedTabId = localStorage.getItem('dashboardActiveTab');
    if (savedTabId) {
        const savedTab = document.getElementById(savedTabId);
        if (savedTab) {
            new bootstrap.Tab(savedTab).show();
        }
    }

    document.querySelectorAll('[data-bs-toggle="tab"]').forEach(btn => {
        btn.addEventListener('shown.bs.tab', e => {
            localStorage.setItem('dashboardActiveTab', e.target.id);
        });
    });
});

window.adjustQty = function(btn, delta) {
    const input = btn.parentElement.querySelector('input[type="number"]');
    let val = parseInt(input.value) || 1;
    const max = parseInt(input.max) || 99;
    val = Math.max(1, Math.min(max, val + delta));
    input.value = val;
};

window.showToast = function(message, type = 'info') {
    const typeMap = {
        'success': 'success',
        'error': 'danger',
        'warning': 'warning',
        'info': 'info'
    };
    
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${typeMap[type] || 'info'} border-0 shadow-lg modern-toast compact`;
    toast.setAttribute('role', 'alert');
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    const container = document.getElementById('toast-container') || document.body;
    container.appendChild(toast);
    
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    toast.addEventListener('hidden.bs.toast', () => toast.remove());
};
</script>

<!-- Kompaktn√≠ modern√≠ CSS - p≈ô√≠jemn√© barvy -->
<style>
:root {
    --primary-color: #54ae43;
    --accent-color: #f28c28;
}

.bg-gradient-primary {
    background: linear-gradient(135deg, var(--primary-color), #4a9b3a) !important;
}

.bg-gradient-accent {
    background: linear-gradient(135deg, var(--accent-color), #e07b1f) !important;
}

.bg-gradient-light {
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
}

.bg-light-soft {
    background: #f8f9fa !important;
}

.bg-success-soft {
    background: #e8f5e8 !important;
    border-left: 3px solid #4caf50 !important;
}

.bg-warning-soft {
    background: #fff3cd !important;
    border: 2px solid #ffc107 !important;
}

.modern-card.compact {
    border: none !important;
    box-shadow: 0 8px 25px rgba(0,0,0,0.1) !important;
    transition: all 0.3s ease;
}

.modern-card.compact:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 35px rgba(0,0,0,0.15) !important;
}

.custom-menu-tabs-modern.compact {
    background: linear-gradient(135deg, var(--primary-color), #4a9b3a) !important;
    border: none !important;
}

.custom-menu-tabs-modern .nav-link {
    color: #ffffff !important;
    background: transparent !important;
    border: none !important;
    border-radius: 0 !important;
    transition: all 0.3s ease;
    font-weight: 500;
    font-size: 0.95rem;
}

.custom-menu-tabs-modern .nav-link:hover {
    background: rgba(255,255,255,0.1) !important;
}

.custom-menu-tabs-modern .nav-link.active {
    background: linear-gradient(135deg, var(--accent-color), #e07b1f) !important;
    color: white !important;
    box-shadow: 0 4px 12px rgba(242,140,40,0.3);
}

.modern-account-status.compact {
    background: linear-gradient(135deg, #e8f5e8, #d4edda) !important;
    border: 1px solid #c8e6c9 !important;
    border-radius: 12px !important;
    font-size: 0.9rem;
}

.modern-calendar-table.compact {
    font-size: 0.8rem;
    background: #ffffff;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 15px rgba(0,0,0,0.08);
}

.modern-day-header.compact {
    background: #e9ecef !important;
    font-weight: 600 !important;
    padding: 0.5rem 0.25rem !important;
    color: #495057 !important;
    font-size: 0.75rem;
}

.modern-day-cell.compact {
    height: 3rem;
    vertical-align: middle;
    border: 1px solid #e0e6ed !important;
    transition: all 0.3s ease;
}

.day-cell-soft {
    transition: all 0.2s ease;
}

.day-cell-soft:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    z-index: 5;
}

.menu-day-link-soft {
    color: #2e7d32 !important;
    font-weight: 600 !important;
    background: rgba(84,174,67,0.08) !important;
    border: 1px solid rgba(84,174,67,0.2) !important;
}

.menu-day-link-soft:hover {
    color: #1b5e20 !important;
    background: rgba(84,174,67,0.15) !important;
    box-shadow: 0 2px 8px rgba(84,174,67,0.2);
}

.selected-day-soft {
    background: #fff3cd !important;
    color: #856404 !important;
    font-weight: 700 !important;
    font-size: 0.9rem !important;
    box-shadow: inset 0 1px 3px rgba(0,0,0,0.08);
}

.menu-day-soft {
    border-left: 3px solid #4caf50 !important;
}

.modern-day-section.compact {
    border: 1px solid #e0e6ed !important;
    transition: all 0.2s ease;
}

.modern-alert.compact {
    background: linear-gradient(135deg, #e3f2fd, #bbdefb) !important;
    border: 1px solid #90caf9 !important;
    border-radius: 12px !important;
    font-size: 0.95rem;
}

.modern-toast.compact {
    border-radius: 12px !important;
    font-size: 0.9rem;
}

.compact-title {
    font-size: 1.4rem;
}

.btn-primary, .btn-success {
    background: linear-gradient(135deg, var(--primary-color), #4a9b3a) !important;
    border: none !important;
    box-shadow: 0 2px 8px rgba(84,174,67,0.3);
}

.btn-primary:hover, .btn-success:hover {
    background: linear-gradient(135deg, var(--accent-color), #e07b1f) !important;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(242,140,40,0.4);
}

.shadow-md {
    box-shadow: 0 4px 15px rgba(0,0,0,0.08) !important;
}

.shadow-lg {
    box-shadow: 0 10px 30px rgba(0,0,0,0.12) !important;
}
</style>
{% endblock %}
